use anchor_lang::prelude::*;
use anchor_lang::solana_program::{
    program::invoke,
    program::invoke_signed,
    system_instruction,
};
use std::str::FromStr;


// ĞŸÑ€ĞµÑ„Ğ¸ĞºÑ Ğ´Ğ»Ñ PDA Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ñƒ
const USER_SEED_PREFIX: &str = "u=";
// ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»Ñ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸    key3
pub const REGISTRATION_FEE_RECEIVER: &str = "6bFc5Gz5qF172GQhK5HpDbWs8F6qcSxdHn5XqAstf1fY"; 


/// ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ° test_utils
#[derive(Accounts)]
pub struct TestContext<'info> {
    /// ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Anchor
    /// CHECK: Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ. ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ.
    #[account(signer)]
    pub signer: AccountInfo<'info>,

    /// ĞĞºĞºĞ°ÑƒĞ½Ñ‚, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ
    /// CHECK: Ğ­Ñ‚Ğ¾ PDA, Ñ‡ÑŒÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· seeds Ğ¸ signer
    #[account(mut)]
    pub writable_pda: AccountInfo<'info>,

    /// ĞĞºĞºĞ°ÑƒĞ½Ñ‚, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ
    /// CHECK: Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ. ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ.
    pub readonly_pda: AccountInfo<'info>,

    /// Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° (Ğ½ÑƒĞ¶Ğ½Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ)/// 
    /// CHECK: Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ. ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ.
    pub system_program: Program<'info, System>,}

/// Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹
pub fn test(
    ctx: Context<TestContext>,     // ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ñ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°Ğ¼Ğ¸
    extra_pubkey: Pubkey,          // Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ĞºĞ»ÑÑ‡ (Ğ½ĞµĞ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼Ñ‹Ğ¹)
    number: u64,                   // Ñ‡Ğ¸ÑĞ»Ğ¾
    note: String,                  // ÑÑ‚Ñ€Ğ¾ĞºĞ°
    str_array: Vec<String>,        // Ğ¼Ğ°ÑÑĞ¸Ğ² ÑÑ‚Ñ€Ğ¾Ğº Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹
) -> Result<()> {
    // ĞŸĞµÑ‡Ğ°Ñ‚Ğ°ĞµĞ¼ Ğ²ÑÑ‘ Ğ² Ğ»Ğ¾Ğ³
    msg!("Signer: {:?}", ctx.accounts.signer.key);
    msg!("Writable PDA: {:?}", ctx.accounts.writable_pda.key);
    msg!("Readonly PDA: {:?}", ctx.accounts.readonly_pda.key);
    msg!("Extra pubkey: {:?}", extra_pubkey);
    msg!("Number: {}", number);
    msg!("Note: {}", note);
    msg!("Array length: {}", str_array.len());
    for (i, s) in str_array.iter().enumerate() {
        msg!("str_array[{}] = {}", i, s);
    }

    

// ---  ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñƒ
    
    let raw_bytes = safe_read_pda(&ctx.accounts.readonly_pda);
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹
    require!(!raw_bytes.is_empty(), ErrorCode::EmptyPdaData);
    msg!("Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: {}", raw_bytes.len());

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ´ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    let user = deserialize_my_user(&*raw_bytes)?;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    msg!("âœ… Ğ”ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°, Ğ»Ğ¾Ğ³Ğ¸Ğ½: {}", user.login);    
    
    // ĞŸĞµÑ‡Ğ°Ñ‚Ğ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¿Ğ¾ Ğ±Ğ°Ğ¹Ñ‚Ğ°Ğ¼: [00 2A FF ...]
    let mut output = String::new();
    for (i, byte) in raw_bytes.iter().enumerate() {
        use std::fmt::Write;

        if i % 16 == 0 {
            // ĞĞ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° Ñ Ğ°Ğ´Ñ€ĞµÑĞ¾Ğ¼ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
            let _ = write!(output, "\n{:04X}: ", i);
        }
        let _ = write!(output, "{:02X} ", byte);
    }
    msg!("ğŸ“¦ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ PDA:{}", output);


    
    
    
    
    
    
// --- Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° UserStruct ĞµĞ³Ğ¾ Ğ¸ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸    
    // --- Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ MyUserStruct
    let user_struct = UserStruct {
        user_id: number,                               // Ğ»ÑĞ±Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
        login: note.clone(),                        // Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‚ÑŒ note.clone() Ğ¸Ğ»Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ¸Ğ· Ğ¼Ğ°ÑÑĞ¸Ğ²Ğ°
        pubkey: ctx.accounts.signer.key().clone(),  // Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, signer
    };

    // --- Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ Ğ² Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ±Ğ°Ğ¹Ñ‚
     let serialized_bytes = serialize_my_user(&user_struct);



    // ---  ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ PDA Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ğ½ĞµĞ³Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ¼Ğ°ÑÑĞ¸Ğ²Ğ°
    let seed_string = format!("{}{}", USER_SEED_PREFIX, note);
    let seed_bytes = seed_string.as_bytes();

        
    // ĞŸĞ¾Ğ¸ÑĞº PDA
    let seeds: &[&[u8]] = &[seed_bytes];
    let (expected_pda, bump) = Pubkey::find_program_address(seeds, ctx.program_id);
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° PDA
    require!(ctx.accounts.writable_pda.key == &expected_pda, ErrorCode::InvalidPdaAddress);

    // ĞŸĞ¾Ğ»Ğ½Ñ‹Ğµ ÑĞ¸Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸
    let full_seeds: &[&[u8]] = &[seed_bytes, &[bump]];

    msg!("serialized_bytes.len() as u64 {}", serialized_bytes.len() as u64);
    // Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ
    create_and_write_pda(
        &ctx.accounts.writable_pda,
        &ctx.accounts.signer,
        &ctx.accounts.system_program,
        ctx.program_id,
        full_seeds,
        serialized_bytes.clone(),
        serialized_bytes.len() as u64,
    )?;
    
    
    Ok(())
}







/// ÑĞ´ĞµÑÑŒ ĞºĞ¾Ğ´Ñ‹ Ğ²ÑĞµÑ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº 

#[error_code]
pub enum ErrorCode {
    #[msg("PDA Ğ½Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½")]
    EmptyPdaData = 6002,

    #[msg("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½")]
    UserAlreadyExists = 6003,

    #[msg("ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³Ğ¸Ğ½")]
    InvalidLogin = 6004,

    #[msg("ĞĞµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ PDA Ğ°Ğ´Ñ€ĞµÑ")]
    InvalidPdaAddress = 6006,

    #[msg("Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ")]
    UnsupportedFormat = 7001,

    #[msg("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ´ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸")]
    DeserializationError = 7002,

    /// PDA ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾
    #[msg("PDA-Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾.")]
    PdaAlreadyExists = 1009,

    /// Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒĞ¶Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾!
    #[msg("Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒĞ¶Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾!")]
    SystemAlreadyInitialized = 4000,
}
#[error_code]
pub enum UserDataError {
    #[msg("Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ")]
    UnsupportedFormat = 7001,

    #[msg("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ´ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸")]
    DeserializationError = 7002,
}

///---------------------------------------------------------------------------------
///
///   Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯ Ğ˜ Ğ•Ğ Ğ¡Ğ•Ğ Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ˜ Ğ”Ğ•Ğ¡Ğ•Ğ Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
///
/// --------------------------------------------------------------------------------
 
/// ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
pub struct UserStruct {
    //pub format_type: u32,   // 4 Ğ±Ğ°Ğ¹Ñ‚Ğ°        Ğ½Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ¼
    pub user_id: u64,       // 8 Ğ±Ğ°Ğ¹Ñ‚
    pub login: String,      // ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ»Ğ¸Ğ½Ğ°, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ±Ğ°Ğ¹Ñ‚Ñ‹
    pub pubkey: Pubkey,     // 32 Ğ±Ğ°Ğ¹Ñ‚Ğ°
}

///    ------------  Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ -----------
// ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

// let user_bytes = serialize_my_user(&some_user);
// match deserialize_my_user(&user_bytes) {
// Ok(user) => msg!("Ğ”ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ»Ğ¾Ğ³Ğ¸Ğ½: {}", user.login),
// Err(e) => msg!("ĞÑˆĞ¸Ğ±ĞºĞ°: {}", e),
// }

/// ĞœĞµÑ‚Ğ¾Ğ´ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ² Vec<u8>
/// let user = MyUserStruct {
///     format_type: 1,
///     user_id: 42,
///     login: String::from("sol_user"),
///     pubkey: Pubkey::new_unique(),
/// };
/// 
/// let bytes = serialize_my_user(&user);
/// msg!("Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ {} Ğ±Ğ°Ğ¹Ñ‚: {:?}", bytes.len(), bytes);
pub fn serialize_my_user(user: &UserStruct) -> Vec<u8> {
    let mut result = Vec::new();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. format_type (4 Ğ±Ğ°Ğ¹Ñ‚Ğ°)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    result.extend_from_slice(&1u32.to_le_bytes());
    //result.extend_from_slice(&user.format_type.to_le_bytes());  Ğ½Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ¼

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. user_id (8 Ğ±Ğ°Ğ¹Ñ‚)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    result.extend_from_slice(&user.user_id.to_le_bytes());

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3. login: ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ»Ğ¸Ğ½Ğ° (u8), Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ±Ğ°Ğ¹Ñ‚Ñ‹
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let login_bytes = user.login.as_bytes();
    let login_len = login_bytes.len();

    // Ğ•ÑĞ»Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ´Ğ»Ğ¸Ğ½Ğ½ĞµĞµ 255 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² â€” Ğ¾ÑˆĞ¸Ğ±ĞºĞ° (Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ€ĞµĞ¶ĞµĞ¼)
    let login_len_u8 = login_len.min(255) as u8;

    result.push(login_len_u8); // Ğ´Ğ»Ğ¸Ğ½Ğ°
    result.extend_from_slice(&login_bytes[..login_len_u8 as usize]); // ÑÑ‚Ñ€Ğ¾ĞºĞ°

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4. Pubkey (32 Ğ±Ğ°Ğ¹Ñ‚Ğ°)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    result.extend_from_slice(user.pubkey.as_ref());

    result
}
///    ------------  Ğ”ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ -----------

/// ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ: Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¸ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½ÑƒĞ¶Ğ½ÑƒÑ Ğ´ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
pub fn deserialize_my_user(data: &[u8]) -> Result<UserStruct> {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ² Ğ±Ğ°Ğ¹Ñ‚Ğ°Ñ… Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ 4 Ğ±Ğ°Ğ¹Ñ‚Ğ° Ğ¿Ğ¾Ğ´ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
    if data.len() < 4 {
        return Err(error!(UserDataError::DeserializationError));
    }

    // Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 4 Ğ±Ğ°Ğ¹Ñ‚Ğ° â€” Ñ‚Ğ¸Ğ¿ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°
    let format_type = u32::from_le_bytes(data[0..4].try_into().map_err(|_| UserDataError::DeserializationError)?);

    // Ğ’ĞµÑ‚Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°
    match format_type {
        1 => deserialize_format_1(data),
        // 2 => deserialize_format_2(data),
        // 3 => ...
        _ => Err(error!(UserDataError::UnsupportedFormat)),
    }
}

/// Ğ”ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° 1:
/// [0..4]  â†’ format_type: u32
/// [4..12] â†’ user_id: u64
/// [12..13] â†’ Ğ´Ğ»Ğ¸Ğ½Ğ° Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°: u8
/// [13..(13+len)] â†’ Ğ»Ğ¾Ğ³Ğ¸Ğ½
/// [..] â†’ 32 Ğ±Ğ°Ğ¹Ñ‚Ğ° pubkey
pub fn deserialize_format_1(data: &[u8]) -> Result<UserStruct> {
    // ĞĞ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²ÑÑ‘ Ğ² Ğ¾Ğ´Ğ½Ñƒ try-Ğ±Ğ»Ğ¾Ğº, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
    let result = (|| {
        if data.len() < 4 + 8 + 1 + 32 {
            return Err(UserDataError::DeserializationError);
        }

        //let format_type = u32::from_le_bytes(data[0..4].try_into().unwrap());  Ğ½Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ¼
        let user_id = u64::from_le_bytes(data[4..12].try_into().unwrap());

        let login_len = data[12] as usize;
        let login_start = 13;
        let login_end = login_start + login_len;

        if data.len() < login_end + 32 {
            return Err(UserDataError::DeserializationError);
        }

        let login_bytes = &data[login_start..login_end];
        let login = std::str::from_utf8(login_bytes)
            .map_err(|_| UserDataError::DeserializationError)?
            .to_string();

        let pubkey_start = login_end;
        let pubkey_end = pubkey_start + 32;
        let pubkey = Pubkey::try_from(&data[pubkey_start..pubkey_end])
            .map_err(|_| UserDataError::DeserializationError)?;


        Ok(UserStruct {
            user_id,
            login,
            pubkey,
        })
    })();

    // ĞĞ±ĞµÑ€Ğ½Ñ‘Ğ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ, ĞµÑĞ»Ğ¸ Ğ»ÑĞ±Ğ°Ñ Ğ¸Ğ· Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ ÑƒĞ¿Ğ°Ğ»Ğ°
    result.map_err(|_| error!(UserDataError::DeserializationError))
}










/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
///  Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° UserByLogin
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
///
/// Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚:
/// - login: String               â€” ÑÑ‚Ñ€Ğ¾ĞºĞ° (Ğ´Ğ¾ 255 Ğ±Ğ°Ğ¹Ñ‚, Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ğ´Ğ»Ğ¸Ğ½Ñƒ + ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ)
/// - id: u64                     â€” 8 Ğ±Ğ°Ğ¹Ñ‚ (Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾)
/// - pubkey: Pubkey             â€” 32 Ğ±Ğ°Ğ¹Ñ‚Ğ°
/// - status: u32                â€” 4 Ğ±Ğ°Ğ¹Ñ‚Ğ°
///
/// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:
/// [0..4]      = format_type: u32 (Ğ²ÑĞµĞ³Ğ´Ğ° 1)
/// [4..5]      = Ğ´Ğ»Ğ¸Ğ½Ğ° Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°: u8
/// [5..(5+len)] = Ğ»Ğ¾Ğ³Ğ¸Ğ½
/// [...]       = id: u64
/// [...]       = pubkey: [u8; 32]
/// [...]       = status: u32
/// Ğ’ÑĞµĞ³Ğ¾: 4 + 1 + Ğ»Ğ¾Ğ³Ğ¸Ğ½ + 8 + 32 + 4 Ğ±Ğ°Ğ¹Ñ‚Ğ°
/// ------------------------------------------------------------------------

pub struct UserByLogin {
    pub login: String,    // Ğ»Ğ¾Ğ³Ğ¸Ğ½ (ÑÑ‚Ñ€Ğ¾ĞºĞ°)
    pub id: u64,          // Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğ¹ ID
    pub pubkey: Pubkey,   // Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡
    pub status: u32,      // ÑÑ‚Ğ°Ñ‚ÑƒÑ
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ”§ Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ serialize_user_by_login()
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
///
/// Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ `UserByLogin` Ğ² `Vec<u8>`, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ format_type = 1
pub fn serialize_user_by_login(user: &UserByLogin) -> Vec<u8> {
    let mut result = Vec::new();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. format_type (4 Ğ±Ğ°Ğ¹Ñ‚Ğ°)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    result.extend_from_slice(&1u32.to_le_bytes()); // Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ 1

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. login: Ğ´Ğ»Ğ¸Ğ½Ğ° (u8) + Ğ±Ğ°Ğ¹Ñ‚Ñ‹
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let login_bytes = user.login.as_bytes();
    let login_len = login_bytes.len();
    let login_len_u8 = login_len.min(255) as u8; // Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 255 Ğ±Ğ°Ğ¹Ñ‚

    result.push(login_len_u8); // Ğ´Ğ»Ğ¸Ğ½Ğ°
    result.extend_from_slice(&login_bytes[..login_len_u8 as usize]);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3. id (u64)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    result.extend_from_slice(&user.id.to_le_bytes());

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4. pubkey (32 Ğ±Ğ°Ğ¹Ñ‚Ğ°)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    result.extend_from_slice(user.pubkey.as_ref());

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5. status (4 Ğ±Ğ°Ğ¹Ñ‚Ğ°)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    result.extend_from_slice(&user.status.to_le_bytes());

    result
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
///ğŸ”„ Ğ”ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ deserialize_user_by_login()
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
///
/// ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¸ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
pub fn deserialize_user_by_login(data: &[u8]) -> Result<UserByLogin> {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ»Ğ¸Ğ½Ñ‹
    if data.len() < 4 {
        return Err(error!(UserDataError::DeserializationError));
    }

    // Ğ¡Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ format_type
    let format_type = u32::from_le_bytes(data[0..4].try_into().unwrap());

    match format_type {
        1 => deserialize_user_by_login_format1(data),
        _ => Err(error!(UserDataError::UnsupportedFormat)),
    }
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// Ğ Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ user_by_login Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ 1:
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fn deserialize_user_by_login_format1(data: &[u8]) -> Result<UserByLogin> {
    let mut offset = 4; // Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ format_type

    // 1. login (Ğ´Ğ»Ğ¸Ğ½Ğ° + ÑÑ‚Ñ€Ğ¾ĞºĞ°)
    let login_len = data.get(offset).ok_or(UserDataError::DeserializationError)? as &u8;
    offset += 1;

    let login_end = offset + (*login_len as usize);
    if data.len() < login_end {
        return Err(error!(UserDataError::DeserializationError));
    }

    let login = std::str::from_utf8(&data[offset..login_end])
        .map_err(|_| error!(UserDataError::DeserializationError))?
        .to_string();
    offset = login_end;

    // 2. id (u64)
    if data.len() < offset + 8 {
        return Err(error!(UserDataError::DeserializationError));
    }
    let id = u64::from_le_bytes(data[offset..offset + 8].try_into().unwrap());
    offset += 8;

    // 3. pubkey (32 Ğ±Ğ°Ğ¹Ñ‚Ğ°)
    if data.len() < offset + 32 {
        return Err(error!(UserDataError::DeserializationError));
    }
    let pubkey = Pubkey::new_from_array(data[offset..offset + 32].try_into().unwrap());
    offset += 32;

    // 4. status (u32)
    if data.len() < offset + 4 {
        return Err(error!(UserDataError::DeserializationError));
    }
    let status = u32::from_le_bytes(data[offset..offset + 4].try_into().unwrap());

    Ok(UserByLogin {
        login,
        id,
        pubkey,
        status,
    })
}




/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// Ğ ĞĞ‘ĞĞ¢Ğ Ğ¡ user_counter_pda
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
///


/// ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğ° Ğ´Ğ»Ñ ÑĞ¸Ğ´Ğ¾Ğ² PDA-ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
pub const USER_COUNTER_SEED: &str = "user_counter";


/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸Ğ· PDA
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
///
pub fn read_user_counter_pda<'info>(
    counter_pda: &AccountInfo<'info>, // Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚
    program_id: &Pubkey,              // ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹
) -> Result<u64> {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ PDA ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ ÑĞ¸Ğ´Ñƒ
    let seeds: &[&[u8]] = &[USER_COUNTER_SEED.as_bytes()];
    let (expected_pda, _) = Pubkey::find_program_address(seeds, program_id);
    require!(counter_pda.key == &expected_pda, ErrorCode::InvalidPdaAddress);

    // Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    let raw = safe_read_pda(counter_pda);
    if raw.len() != 8 {
        return Err(error!(ErrorCode::EmptyPdaData)); // Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€
    }

    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ 8 Ğ±Ğ°Ğ¹Ñ‚ Ğ² u64
    let value = u64::from_le_bytes(raw.try_into().map_err(|_| ErrorCode::DeserializationError)?);
    Ok(value)
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ² PDA
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pub fn write_user_counter_pda<'info>(
    counter_pda: &AccountInfo<'info>,
    program_id: &Pubkey,
    value: u64,
) -> Result<()> {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°Ğ´Ñ€ĞµÑ PDA
    let seeds: &[&[u8]] = &[USER_COUNTER_SEED.as_bytes()];
    let (expected_pda, _) = Pubkey::find_program_address(seeds, program_id);
    require!(counter_pda.key == &expected_pda, ErrorCode::InvalidPdaAddress);

    // Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ u64 Ğ² 8 Ğ±Ğ°Ğ¹Ñ‚
    let bytes = value.to_le_bytes().to_vec();

    // Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ² PDA
    write_to_pda(counter_pda, &bytes)
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ PDA ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (Ğ¾Ğ´Ğ½Ğ¾ĞºÑ€Ğ°Ñ‚Ğ½Ğ°Ñ)
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
///
/// ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°
#[derive(Accounts)]
pub struct InitUserCounter<'info> {
    /// Ğ¢Ğ¾Ñ‚, ĞºÑ‚Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ Ğ·Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ PDA
    /// CHECK: Ğ­Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‚, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Anchor Ñ‡ĞµÑ€ĞµĞ· #[account(signer)]
    #[account(mut, signer)]
    pub signer: AccountInfo<'info>,

    /// ĞĞºĞºĞ°ÑƒĞ½Ñ‚-ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ PDA Ñ ÑĞ¸Ğ´Ğ¾Ğ¼ ["user_counter"]
    /// CHECK: Ğ­Ñ‚Ğ¾ PDA, Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ğ² ĞºĞ¾Ğ´Ğµ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¿Ğ¾ ÑĞ¸Ğ´-Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
    #[account(mut)]
    pub counter_pda: AccountInfo<'info>,

    /// Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Solana
    pub system_program: Program<'info, System>,
}
/// Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
pub fn initialize_user_counter<'info>(
    counter_pda: &AccountInfo<'info>,
    signer: &AccountInfo<'info>,         // Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ Ğ·Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ
    system_program: &AccountInfo<'info>, // ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°
    program_id: &Pubkey,
) -> Result<()> {
    // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PDA Ğ¸Ğ· ÑĞ¸Ğ´Ğ¾Ğ²
    let seeds: &[&[u8]] = &[USER_COUNTER_SEED.as_bytes()];
    let (expected_pda, bump) = Pubkey::find_program_address(seeds, program_id);
    require!(counter_pda.key == &expected_pda, ErrorCode::InvalidPdaAddress);

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° â€” ĞµÑĞ»Ğ¸ PDA ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹
    if counter_pda.owner != &Pubkey::default() {
        msg!("PDA Ğ¡Ğ¾ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚. Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒĞ¶Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°!");
        return Err(error!(ErrorCode::SystemAlreadyInitialized));
    }

    // ĞŸĞ¾Ğ»Ğ½Ñ‹Ğµ ÑĞ¸Ğ´Ñ‹
    let full_seeds: &[&[u8]] = &[USER_COUNTER_SEED.as_bytes(), &[bump]];

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ PDA Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ‚ÑƒĞ´Ğ° 0
    create_and_write_pda(
        counter_pda,
        signer,
        system_program,
        program_id,
        full_seeds,
        0u64.to_le_bytes().to_vec(), // Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ 0
        8,                           // Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ â€” 8 Ğ±Ğ°Ğ¹Ñ‚ (u64)
    )?;
    msg!("PDA Ğ¡Ğ¾ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
    Ok(())
}





















/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// Ğ Ğ•Ğ“Ğ˜Ğ¡Ğ¢Ğ ĞĞ¦Ğ˜Ğ¯ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ÑˆĞ°Ğ³ ĞŸĞ•Ğ Ğ’Ğ«Ğ™) Ğ¿Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ñƒ
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


pub fn register_user_step_one(
    ctx: Context<RegisterUserStepOne>,
    login: String,
    user_pubkey: Pubkey,
) -> Result<()> {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°
    validate_login(&login)?; // Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ½Ğ¸Ğ¶Ğµ

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ "Ğ¾ÑĞ¾Ğ±Ñ‹Ğ¼" (Ğ·Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼)
    let reserved_logins = ["admin", "support", "solana"]; // Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ
    require!(
        !reserved_logins.contains(&login.as_str()),
        ErrorCode::InvalidLogin
    );

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° PDA
    let seed_string = format!("{}{}", USER_SEED_PREFIX, login);
    let seed_bytes = seed_string.as_bytes();
    let (expected_pda, bump) = Pubkey::find_program_address(&[seed_bytes], ctx.program_id);
    require!(
        &expected_pda == ctx.accounts.user_by_login_pda.key,
        ErrorCode::InvalidPdaAddress
    );

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ PDA ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
    if ctx.accounts.user_by_login_pda.owner != &Pubkey::default() {
        return Err(error!(ErrorCode::UserAlreadyExists));
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5. ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´ 0.01 SOL ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ Ğ·Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
    let expected_receiver = Pubkey::from_str(REGISTRATION_FEE_RECEIVER)
        .map_err(|_| error!(ErrorCode::InvalidLogin))?;
    require!(
        ctx.accounts.fee_receiver.key == &expected_receiver,
        ErrorCode::InvalidPdaAddress
    );

    let transfer_instruction = system_instruction::transfer(
        ctx.accounts.signer.key,
        ctx.accounts.fee_receiver.key,
        10_000_000, // 0.01 SOL Ğ² Ğ»Ğ°Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°Ñ…
    );
    invoke(
        &transfer_instruction,
        &[
            ctx.accounts.signer.clone(),
            ctx.accounts.fee_receiver.clone(),
            ctx.accounts.system_program.to_account_info(),
        ],
    )?;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 6. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº
    let current_id = read_user_counter_pda(&ctx.accounts.user_counter, ctx.program_id)?;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 7. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ UserByLogin
    let user = UserByLogin {
        login: login.clone(),
        id: current_id + 1,
        pubkey: user_pubkey,
        status: 0,
    };

    let serialized_user = serialize_user_by_login(&user);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 8. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ PDA Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ² Ğ½ĞµĞ³Ğ¾ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    let full_seeds: &[&[u8]] = &[seed_bytes, &[bump]];
    create_pda(
        &ctx.accounts.user_by_login_pda,
        &ctx.accounts.signer,
        &ctx.accounts.system_program.to_account_info(),
        ctx.program_id,
        full_seeds,
        serialized_user.len() as u64,
    )?;

    write_to_pda(&ctx.accounts.user_by_login_pda, &serialized_user)?;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 9. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    write_user_counter_pda(
        &ctx.accounts.user_counter,
        ctx.program_id,
        current_id + 1,
    )?;

    msg!("âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½: {}", login);
    Ok(())
}


/// Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
#[derive(Accounts)]
pub struct RegisterUserStepOne<'info> {
    /// CHECK: Ğ­Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‚, Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Anchor Ğ¿Ğ¾ ĞºĞ»ÑÑ‡Ñƒ Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸
    /// ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‚ â€” Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ, Ğ¾Ğ½ Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ Ğ·Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ PDA
    #[account(mut, signer)]
    pub signer: AccountInfo<'info>,

    /// CHECK: ÑÑ‚Ğ¾ PDA, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¸Ğ´Ñ‹ Ğ¸ ĞºĞ»ÑÑ‡
    /// PDA ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    #[account(mut)]
    pub user_counter: AccountInfo<'info>,

    /// CHECK: PDA-Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¸Ğ´ `"u=" + login`
    /// ĞĞ¾Ğ²Ñ‹Ğ¹ PDA-Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ñƒ
    #[account(mut)]
    pub user_by_login_pda: AccountInfo<'info>,

    /// Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°
    pub system_program: Program<'info, System>,

    /// ĞĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»Ñ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ)
    /// CHECK: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ
    #[account(mut)]
    pub fee_receiver: AccountInfo<'info>,
}

/// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ğ½ ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ¸Ğ· Ğ»Ğ°Ñ‚Ğ¸Ğ½ÑĞºĞ¸Ñ… ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ğ±ÑƒĞºĞ², Ñ†Ğ¸Ñ„Ñ€ Ğ¸ "_"
/// Ğ¸ Ğ´Ğ»Ğ¸Ğ½Ğ° Ğ½Ğµ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ 30 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
pub fn validate_login(login: &str) -> Result<()> {
    if login.len() > 30 {
        return Err(error!(ErrorCode::InvalidLogin));
    }

    for ch in login.chars() {
        if !(ch.is_ascii_lowercase() || ch.is_ascii_digit() || ch == '_') {
            return Err(error!(ErrorCode::InvalidLogin));
        }
    }

    Ok(())
}






























///----------------------------------------------------------------------------------------------------------
///   Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ  PDA
///----------------------------------------------------------------------------------------------------------

/// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ PDA Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ (ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚), Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ² Ğ½ĞµĞ³Ğ¾ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ±Ğ°Ğ¹Ñ‚.
///
/// ĞÑ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹:
/// - `pda_account`: Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚, ĞºÑƒĞ´Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼
/// - `signer`: ĞºÑ‚Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ Ğ·Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ)
/// - `program_id`: Ğ°Ğ´Ñ€ĞµÑ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹
/// - `seeds`: ÑĞ»Ğ°Ğ¹Ñ ÑĞ¸Ğ´Ğ¾Ğ², Ğ¿Ğ¾ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ»ÑÑ PDA
/// - `data`: Ğ±Ğ°Ğ¹Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
/// - `space`: Ğ¶ĞµĞ»Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°
pub fn create_and_write_pda<'info>(
    pda_account: &AccountInfo<'info>,
    signer: &AccountInfo<'info>,
    system_program: &AccountInfo<'info>,
    program_id: &Pubkey,
    seeds: &[&[u8]],
    data: Vec<u8>,
    space: u64,
) -> Result<()> {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ»Ğ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ (ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ â€” owner = default)
    if pda_account.owner == &Pubkey::default() {
        msg!("Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ PDA Ñ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ¾Ğ¼ {} Ğ±Ğ°Ğ¹Ñ‚", space);

        let space = space; //+ 128; // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ·Ğ°Ğ¿Ğ°Ñ Ğ¿Ğ¾Ğ´ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
        // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼ÑƒÑ Ğ°Ñ€ĞµĞ½Ğ´Ğ½ÑƒÑ Ğ¿Ğ»Ğ°Ñ‚Ñƒ
        let lamports = Rent::get()?.minimum_balance(space as usize);

        // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ
        let create_instr = system_instruction::create_account(
            signer.key,
            pda_account.key,
            lamports,
            space,
            program_id,
        );

        // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒÑ Ğ¾Ñ‚ PDA
        invoke_signed(
            &create_instr,
            &[
                signer.clone(),
                pda_account.clone(),
                system_program.clone(),
            ],
            &[&seeds],
        )?;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. ĞŸĞ¸ÑˆĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚
    let mut account_data = pda_account.try_borrow_mut_data()?;

    let copy_len = std::cmp::min(account_data.len(), data.len());
    account_data[..copy_len].copy_from_slice(&data[..copy_len]);

    // Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞµĞµÑÑ Ğ½ÑƒĞ»ÑĞ¼Ğ¸ â€” Ñ€Ğ°ÑĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞ¹:
    // for i in copy_len..account_data.len() {
    //     account_data[i] = 0;
    // }

    msg!("Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ {} Ğ±Ğ°Ğ¹Ñ‚ Ğ² PDA", copy_len);
    Ok(())
}




/// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ PDA Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ (ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚).
///
/// âš ï¸ Ğ•ÑĞ»Ğ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, Ğ²Ñ‹Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°.
/// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¹ ÑĞ¼Ğ°Ñ€Ñ‚-ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ğ°.
///
/// ĞÑ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹:
/// - `pda_account`: Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ…Ğ¾Ñ‚Ğ¸Ğ¼ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ (PDA)
/// - `signer`: ĞºÑ‚Ğ¾ Ğ¾Ğ¿Ğ»Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ)
/// - `system_program`: ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° (`111...111`)
/// - `program_id`: Ğ°Ğ´Ñ€ĞµÑ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ PDA)
/// - `seeds`: Ğ¼Ğ°ÑÑĞ¸Ğ² ÑĞ¸Ğ´Ğ¾Ğ², Ğ¿Ğ¾ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞ»ÑÑ PDA
/// - `space`: Ğ¶ĞµĞ»Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° Ğ² Ğ±Ğ°Ğ¹Ñ‚Ğ°Ñ… (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ±ĞµĞ· Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
pub fn create_pda<'info>(
    pda_account: &AccountInfo<'info>,
    signer: &AccountInfo<'info>,
    system_program: &AccountInfo<'info>,
    program_id: &Pubkey,
    seeds: &[&[u8]],
    space: u64,
) -> Result<()> {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚
    if pda_account.owner != &Pubkey::default() {
        // Ğ•ÑĞ»Ğ¸ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† Ğ½Ğµ Ñ€Ğ°Ğ²ĞµĞ½ Pubkey::default, Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ ÑƒĞ¶Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½
        // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ñ Ğ¿Ğ¾ÑÑĞ½ĞµĞ½Ğ¸ĞµĞ¼
        return Err(error!(ErrorCode::PdaAlreadyExists));
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ±ÑƒĞ´ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ PDA
    msg!("Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ PDA-Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğ° {} Ğ±Ğ°Ğ¹Ñ‚", space);

    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ğ°Ñ Ğ¿Ğ¾Ğ´ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Solana (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ 128 Ğ±Ğ°Ğ¹Ñ‚)
    let full_space = space + 128;

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ´Ğ»Ñ Ğ°Ñ€ĞµĞ½Ğ´Ñ‹ (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ğ»Ğ¸)
    let lamports = Rent::get()?.minimum_balance(full_space as usize);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ system_program Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°
    let create_instr = system_instruction::create_account(
        signer.key,         // Ğ¾Ñ‚ Ğ¸Ğ¼ĞµĞ½Ğ¸ ĞºĞ¾Ğ³Ğ¾
        pda_account.key,    // Ğ´Ğ»Ñ ĞºĞ°ĞºĞ¾Ğ³Ğ¾ PDA
        lamports,           // ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ»Ğ°Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ² Ğ¿ĞµÑ€ĞµĞ²ĞµÑÑ‚Ğ¸
        full_space,         // ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ±Ğ°Ğ¹Ñ‚ Ğ²Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ
        program_id,         // ĞºÑ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†ĞµĞ¼ PDA
    );

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒÑ PDA (Ñ‡ĞµÑ€ĞµĞ· ÑĞ¸Ğ´Ñ‹)
    invoke_signed(
        &create_instr,
        &[
            signer.clone(),
            pda_account.clone(),
            system_program.clone(),
        ],
        &[&seeds], // PDA ÑĞ¸Ğ´Ñ‹ â†’ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸
    )?;

    Ok(())
}

/// Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ±Ğ°Ğ¹Ñ‚ Ğ² PDA Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ (Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ data-ÑĞµĞºÑ†Ğ¸Ğ¸).
///
/// âš ï¸ Ğ£Ğ±ĞµĞ´Ğ¸ÑÑŒ, Ñ‡Ñ‚Ğ¾ PDA Ğ±Ñ‹Ğ» Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½ ĞºĞ°Ğº `#[account(mut)]`
/// âš ï¸ Ğ­Ñ‚Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¸ÑˆĞµÑ‚.
///
/// ĞÑ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹:
/// - `pda_account`: Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚, Ğ² ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¸ÑˆĞµĞ¼ (Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ mut)
/// - `data`: Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ
pub fn write_to_pda<'info>(
    pda_account: &AccountInfo<'info>,
    data: &[u8],
) -> Result<()> {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ PDA (Ğ½Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ)
    let mut account_data = pda_account.try_borrow_mut_data()?;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ±Ğ°Ğ¹Ñ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ
    // (Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹, ĞµÑĞ»Ğ¸ data Ğ´Ğ»Ğ¸Ğ½Ğ½ĞµĞµ, Ñ‡ĞµĞ¼ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¾ Ğ¼ĞµÑÑ‚Ğ¾)
    let copy_len = std::cmp::min(account_data.len(), data.len());

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ (Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°)
    account_data[..copy_len].copy_from_slice(&data[..copy_len]);

    // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ±Ğ°Ğ¹Ñ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾
    msg!("Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ {} Ğ±Ğ°Ğ¹Ñ‚ Ğ² PDA", copy_len);

    Ok(())
}










/// ------------------------------------------------------------------------
/// safe_read_pda â€’ Â«Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ PDAÂ»
/// ------------------------------------------------------------------------
///
/// * ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚:   ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° `AccountInfo<'info>` PDA-Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°.
/// * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚:  `Vec<u8>` Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°.  
///                Ğ•ÑĞ»Ğ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ¸Ğ»Ğ¸ ĞµĞ³Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿ÑƒÑÑ‚Ñ‹ â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ `Vec::new()`
///                Ğ´Ğ»Ğ¸Ğ½Ğ¾Ğ¹ 0 Ğ±Ğ°Ğ¹Ñ‚.
///
/// ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ **Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½**: Ñƒ Ğ½Ğµ-Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾
///    owner = Pubkey::default(). Ğ•ÑĞ»Ğ¸ owner Ğ½ÑƒĞ»ĞµĞ²Ğ¾Ğ¹ â€” ÑÑ€Ğ°Ğ·Ñƒ Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ğ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ²ĞµĞºÑ‚Ğ¾Ñ€.
/// 2. Ğ•ÑĞ»Ğ¸ Ğ´Ğ»Ğ¸Ğ½Ğ° Ğ±ÑƒÑ„ĞµÑ€Ğ° == 0 (Anchor helper `data_is_empty()`), Ñ‚Ğ¾Ğ¶Ğµ Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ğ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹.
/// 3. ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ (`try_borrow_data`) Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.
///    - Ğ£ÑĞ¿ĞµÑ… â†’ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ñ… Ğ² Vec Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼.
///    - ĞÑˆĞ¸Ğ±ĞºĞ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚ borrow) â†’ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Vec.
///
/// Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ 
/// let raw_bytes = safe_read_pda(&ctx.accounts.readonly_pda);
/// require!(!raw_bytes.is_empty(), ErrorCode::EmptyPdaData);
/// msg!("Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: {}", raw_bytes.len());
/// ------------------------------------------------------------------------
pub fn safe_read_pda<'info>(pda_account: &AccountInfo<'info>) -> Vec<u8> {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1) ĞĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ*Ğ•* Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ•Ğ¢ Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½:
    // owner == Pubkey::default() (Ğ² Solana Ğ½ÑƒĞ»ĞµĞ²Ğ¾Ğ¹ owner Ñƒ Ğ¿ÑƒÑÑ‚Ğ¾Ğ³Ğ¾ ÑÑ‡Ñ‘Ñ‚Ğ°)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if pda_account.owner == &Pubkey::default() {
        msg!("safe_read_pda: Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ â€’ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²");
        return Vec::new(); // []
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2) Ğ£ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ğ´Ğ»Ğ¸Ğ½Ğ° 0) â€” Ñ‚Ğ¾Ğ¶Ğµ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Â«Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼Â»
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if pda_account.data_is_empty() {
        msg!("safe_read_pda: Ñƒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° data_len == 0 â€’ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²");
        return Vec::new();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3) ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ğ·Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ±ÑƒÑ„ĞµÑ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…; Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match pda_account.try_borrow_data() {
        Ok(data_ref) => {
            // to_vec() ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ bytes â†’ Vec<u8>, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ°Ğ»ÑŒÑˆĞµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ±ĞµĞ· borrow-Ğ»Ğ¸Ñ„Ğ°
            data_ref.to_vec()
        }
        Err(e) => {
            // ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ borrow (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ¼ÑƒÑ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ·Ğ°Ğ¸Ğ¼ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
            msg!("safe_read_pda: Ğ¾ÑˆĞ¸Ğ±ĞºĞ° borrow_data ({:?}) â€’ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²", e);
            Vec::new()
        }
    }
}
